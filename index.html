<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Balance and History</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center">Account Balance and History</h2>
                <div class="card mt-4">
                    <div class="card-header">
                        <h4>Account Balance</h4>
                    </div>
                    <div class="card-body">
                        <p id="balance" class="display-4 text-center">Loading...</p>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <h4>History of Transactions</h4>
                    </div>
                    <div class="card-body">
                        <ul id="history" class="list-group">
                            <li class="list-group-item">Loading...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const pantryUrl = 'https://getpantry.cloud/apiv1/pantry/ad586b77-0421-459c-a631-ffc793bf770f/basket/donat-na-lomonad';
            const myApiUrl = 'https://script.google.com/macros/s/AKfycbxguYebQbigqifFXtAaq_Q_Fo2FfQ0SPLhhk-bmnKFjEvkbCS0aHnUS9zS5z3UpB0Sa/exec';

            fetch(pantryUrl)
                .then(response => response.json())
                .then(data => {
                    // Update balance and history with pantryUrl data
                    updatePage(data);
                    // Check myApi for updated data
                    fetch(myApiUrl)
                        .then(response => response.json())
                        .then(newData => {
                            // Compare data with pantryUrl
                            if (!isEqual(data, newData)) {
                                // If data is different, update page with myApi data
                                updatePage(newData);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching data from myApi:', error);
                        });
                })
                .catch(error => {
                    document.getElementById('balance').innerText = 'Failed to load balance.';
                    document.getElementById('history').innerHTML = '<li class="list-group-item">Failed to load history.</li>';
                    console.error('Error fetching data from pantryUrl:', error);
                });

            function updatePage(data) {
                // Update balance
                document.getElementById('balance').innerText = data.balance + ' RUB';
                // Update history
                const historyElement = document.getElementById('history');
                historyElement.innerHTML = ''; // clear loading text
                data.history.forEach(operation => {
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item';
                    listItem.innerText = `${operation.datetime}: ${operation.amount} RUB - ${operation.title}`;
                    historyElement.appendChild(listItem);
                });
            }

            function isEqual(data1, data2) {
                // Compare balance and history arrays
                return JSON.stringify(data1) === JSON.stringify(data2);
            }
        });
    </script>
</body>

</html>
